<!DOCTYPE html>
<html>
<head>
<title>VRツアー</title>
<meta charset="utf-8">
<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui" />
<link rel="icon" href="vr-icon.ico" type="image/x-icon">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; overflow: hidden; background-color: #000; }
#pano { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

/* UI ボタン類 */
#mapButton {
  position: absolute; bottom: 30px; left: 20px; width: 70px; height: 70px;
  cursor: pointer; z-index: 100; transition: opacity 2s ease, transform 0.3s ease; opacity: 0;
}
#mapButton.visible { opacity: 0.6; }
#mapButton:hover { transform: scale(1.1); opacity: 1; }

#counter {
  position: absolute; bottom: 30px; left: 110px; width: 60px; height: 60px;
  background: white; border: 3px solid #ff0000; border-radius: 50%;
  display: flex; justify-content: center; align-items: center;
  font-size: 24px; font-weight: bold; color: #0066ff; z-index: 100;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: opacity 2s ease; opacity: 0;
}
#counter.visible { opacity: 0.6; }

#volumeContainer {
  position: absolute; bottom: 30px; left: 185px;
  height: 60px; display: flex; align-items: center;
  background: rgba(54, 40, 34, 0.85);
  padding: 0 20px; border-radius: 30px;
  z-index: 100; transition: opacity 2s ease; opacity: 0;
  border: 1px solid rgba(255,255,255,0.2);
  pointer-events: none;
}
#volumeContainer.visible { opacity: 0.8; pointer-events: auto; }

#volumeLabel {
  color: #FF8C00;
  font-weight: bold; font-family: sans-serif;
  margin-right: 12px; font-size: 18px;
}
#volumeSlider {
  cursor: pointer; width: 100px; height: 8px;
  accent-color: #00FF00;
}

/* 矢印ナビ */
.arrow-nav {
  position: absolute; width: 60px; height: 60px; cursor: pointer; z-index: 100;
  transition: opacity 2s ease, transform 0.3s ease; opacity: 0;
}
.arrow-nav.visible { opacity: 0.6; }
.arrow-nav:hover { transform: scale(1.15); opacity: 1; }

#arrowUp { top: 45%; right: 15%; transform: translateY(-80px); }
#arrowDown { top: 45%; right: 15%; transform: translateY(40px); }
#arrowLeft { top: 45%; right: 15%; transform: translateX(-60px); }
#arrowRight { top: 45%; right: 15%; transform: translateX(60px); }

/* 文字ホットスポット */
#textHotspot {
  position: absolute;
  bottom: 25px;
  left: 375px;
  max-width: 55%;
  z-index: 90;
  opacity: 0;
  transition: opacity 1.5s ease-in-out;
  pointer-events: none;
}
#textHotspot.visible { opacity: 1; }

#textHotspot p {
  color: #FFFFFF;
  font-size: 20px;
  font-weight: bold;
  line-height: 1.6;
  margin: 0;
  text-align: left;
  text-shadow:
    2px 2px 4px black,
    -2px 2px 4px black,
    2px -2px 4px black,
    -2px -2px 4px black;
}

/* ジャイロ許可ボタン（修正済み：小さく半透明） */
#gyroPermissionButton {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 5px 10px;
  font-size: 12px;
  background: rgba(0, 128, 0, 0.4);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  z-index: 1000;
  display: none;
  transition: opacity 1s ease;
}

/* スマホ調整 */
@media (max-width: 768px) {
  #textHotspot {
    bottom: 5px;
    left: 170px;
    max-width: calc(100% - 200px);
  }
  #textHotspot p {
    font-size: 16px;
  }
}
</style>
</head>

<body>

<div id="pano"></div>

<img id="mapButton" src="Map戻り-removebg-preview.png" alt="Map" onclick="goToMap()">
<div id="counter">1</div>

<div id="volumeContainer">
  <span id="volumeLabel">VOL</span>
  <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.5">
</div>

<img id="arrowUp" class="arrow-nav" src="上-removebg-preview.png" alt="前進">
<img id="arrowDown" class="arrow-nav" src="下-removebg-preview.png" alt="後退">
<img id="arrowLeft" class="arrow-nav" src="左-removebg-preview.png" alt="左へ">
<img id="arrowRight" class="arrow-nav" src="右-removebg-preview.png" alt="右へ">

<div id="gyroPermissionButton">
  ジャイロON
</div>

<div id="textHotspot">
  <p id="textContent"></p>
</div>

<script src="vendor/screenfull.min.js"></script>
<script src="vendor/bowser.min.js"></script>
<script src="vendor/marzipano.js"></script>
<script src="data.js"></script>

<script>
(function() {
'use strict';

// --- 設定 ---
var SWITCH_THRESHOLD = 91; // 振り向き角度の閾値
var IDLE_TIME = 0; // 操作停止後のジャイロ復帰待ち時間（0=即時）

var Marzipano = window.Marzipano;
var data = window.APP_DATA;
var panoElement = document.querySelector('#pano');

// --- ビューワー初期化 ---
var viewer = new Marzipano.Viewer(panoElement);

var scenes = data.scenes;
var scenesData = {};
var currentScene = null;
var currentView = null;
var currentSceneObj = null;

// --- 音声関連 ---
var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
var currentAudio = null;
var currentVolume = 0.5;
var audioEnabled = false;
var playedPositions = {};

// --- 文字ホットスポット ---
var visitedScenes = {};
var textHotspotElement = document.getElementById('textHotspot');
var textContentElement = document.getElementById('textContent');

// --- ジャイロ変数 ---
var gyroActive = false;
var lastOrientation = { alpha: null, beta: null, gamma: null };
var idleTimer = null;
var gyroInitialized = false;

// --- シーン情報整理（行き・帰り） ---
var sceneInfo = {};
var ikiScenes = [];
var kaeriScenes = [];

scenes.forEach(function(scene) {
  var name = scene.name;
  // 'b'が含まれるかどうかで判定
  if (name.indexOf('b') > -1 || name.indexOf('ｂ') > -1 || name.indexOf('B') > -1) {
    kaeriScenes.push(scene);
  } else {
    ikiScenes.push(scene);
  }
});

// 行き・帰りのペアリング処理
ikiScenes.forEach(function(scene, index) {
  var position = index + 1;
  var pairIndex = ikiScenes.length - index - 1;
  var pairId = kaeriScenes[pairIndex] ? kaeriScenes[pairIndex].id : null;
  sceneInfo[scene.id] = { position: position, direction: 'iki', pair: pairId };
});

kaeriScenes.forEach(function(scene, index) {
  var position = index + 1;
  var pairIndex = kaeriScenes.length - index - 1;
  var pairId = ikiScenes[pairIndex] ? ikiScenes[pairIndex].id : null;
  sceneInfo[scene.id] = { position: position, direction: 'kaeri', pair: pairId };
});

var maxPosition = Math.max(ikiScenes.length, kaeriScenes.length);

// --- シーン作成ループ ---
scenes.forEach(function(sceneData) {
  var urlPrefix = "tiles";
  var source = Marzipano.ImageUrlSource.fromString(
    urlPrefix + "/" + sceneData.id + "/{z}/{f}/{y}/{x}.jpg",
    { cubeMapPreviewUrl: urlPrefix + "/" + sceneData.id + "/preview.jpg" }
  );

  var geometry = new Marzipano.CubeGeometry(sceneData.levels);
  
  var limiter = Marzipano.RectilinearView.limit.traditional(
    2 * sceneData.faceSize, 75*Math.PI/180, 120*Math.PI/180
  );
  
  var view = new Marzipano.RectilinearView(sceneData.initialViewParameters, limiter);

  var scene = viewer.createScene({
    source: source,
    geometry: geometry,
    view: view,
    pinFirstLevel: false
  });

  var info = sceneInfo[sceneData.id] || { position: 1, direction: 'iki', pair: null };

  scenesData[sceneData.id] = {
    scene: scene,
    view: view,
    data: {
      id: sceneData.id,
      position: info.position,
      direction: info.direction,
      pair: info.pair,
      infoHotspots: sceneData.infoHotspots || []
    }
  };
});

// --- シーン切り替え関数 ---
function switchScene(sceneId, newYaw, newPitch) {
  var sceneObj = scenesData[sceneId];
  if (!sceneObj) {
    console.error("Scene not found:", sceneId);
    return;
  }

  var targetView = sceneObj.view;
  if (typeof newYaw !== 'undefined' && typeof newPitch !== 'undefined') {
    targetView.setParameters({ yaw: newYaw, pitch: newPitch });
  }

  sceneObj.scene.switchTo({ transitionDuration: 500 });
  currentScene = sceneObj.scene;
  currentView = targetView;
  currentSceneObj = sceneObj;

  // カウンター更新
  var counterEl = document.getElementById('counter');
  if (counterEl) counterEl.textContent = sceneObj.data.position;

  // 音声再生（行きのみ）
  if (sceneObj.data.direction === 'iki') {
    playPositionSound(sceneObj.data.position);
  }

  showTextHotspot(sceneId);
}

// --- テキストホットスポット表示 ---
function showTextHotspot(sceneId) {
  var sceneObj = scenesData[sceneId];
  if (!sceneObj) return;

  if (sceneObj.data.direction !== 'iki' || visitedScenes[sceneId]) {
    hideTextHotspot();
    return;
  }

  var hotspots = sceneObj.data.infoHotspots;
  if (!hotspots || hotspots.length === 0) {
    hideTextHotspot();
    return;
  }

  var hotspot = hotspots[0];
  if (hotspot.text) {
    textContentElement.textContent = hotspot.text;
    textHotspotElement.classList.add('visible');
    visitedScenes[sceneId] = true;

    setTimeout(hideTextHotspot, 5000);
  } else {
    hideTextHotspot();
  }
}

function hideTextHotspot() {
  textHotspotElement.classList.remove('visible');
}

// --- 角度計算ユーティリティ ---
function normalizeAngle(angle) {
  while (angle > Math.PI) angle -= 2 * Math.PI;
  while (angle < -Math.PI) angle += 2 * Math.PI;
  return angle;
}
function degToRad(deg) { return deg * Math.PI / 180; }
function radToDeg(rad) { return rad * 180 / Math.PI; }

// --- 矢印の表示/非表示 ---
function updateArrowVisibility() {
  if (!currentView || !currentSceneObj) return;

  var params = currentView.parameters();
  var currentYawDeg = Math.abs(radToDeg(normalizeAngle(params.yaw)));

  var arrowUp = document.getElementById('arrowUp');
  var arrowDown = document.getElementById('arrowDown');
  var arrowLeft = document.getElementById('arrowLeft');
  var arrowRight = document.getElementById('arrowRight');
  
  if (!arrowUp) return; // 要素がない場合はスキップ

  if (currentYawDeg <= 45 || currentYawDeg > 135) {
    arrowUp.style.display = 'block';
    arrowDown.style.display = 'block';
    arrowLeft.style.display = 'none';
    arrowRight.style.display = 'none';
  } else {
    arrowUp.style.display = 'none';
    arrowDown.style.display = 'none';
    arrowLeft.style.display = 'block';
    arrowRight.style.display = 'block';
  }
}

// --- 振り向き検知ループ ---
setInterval(function() {
  if (!currentView || !currentSceneObj) return;

  var params = currentView.parameters();
  var currentYaw = normalizeAngle(params.yaw);

  updateArrowVisibility();

  // 180度ターン処理
  if (currentYaw > degToRad(SWITCH_THRESHOLD) || currentYaw < -degToRad(SWITCH_THRESHOLD)) {
    var pairSceneId = currentSceneObj.data.pair;
    if (pairSceneId && scenesData[pairSceneId]) {
      var newYaw = currentYaw > 0 ? currentYaw - Math.PI : currentYaw + Math.PI;
      switchScene(pairSceneId, newYaw, params.pitch);
    }
  }
}, 100);

// --- 音声コントロール ---
var volumeSlider = document.getElementById('volumeSlider');
if (volumeSlider) {
  volumeSlider.addEventListener('input', function() {
    currentVolume = this.value;
    if (currentAudio) currentAudio.volume = currentVolume;
  });
}

function playPositionSound(position) {
  if (!audioEnabled) return;
  if (playedPositions[position]) return;

  var file = "sounds/position" + position + ".mp3";

  if (currentAudio) {
    currentAudio.pause();
    currentAudio = null;
  }

  var audio = new Audio(file);
  audio.volume = currentVolume;
  
  var track = audioCtx.createMediaElementSource(audio);
  track.connect(audioCtx.destination);

  audio.play().catch(function(e) {
    console.log("Audio play failed:", e);
  });

  currentAudio = audio;
  playedPositions[position] = true;
}

function tryEnableAudio() {
  audioEnabled = true;
  if (audioCtx.state === "suspended") audioCtx.resume();
}
document.addEventListener('click', tryEnableAudio, { once: true });
document.addEventListener('touchstart', tryEnableAudio, { once: true });

window.goToMap = function() {
  if (currentAudio) currentAudio.pause();
  visitedScenes = {};
  playedPositions = {};
  window.location.href = "index.html";
};

// --- 移動ロジック ---
function executeMoveByDelta(delta) {
  if (!currentView || !currentSceneObj) return;

  var nextPos = currentSceneObj.data.position + delta;
  if (nextPos < 1 || nextPos > maxPosition) return;

  // 次のポジションのシーンIDを探す
  for (var id in scenesData) {
    if (scenesData[id].data.position === nextPos &&
        scenesData[id].data.direction === currentSceneObj.data.direction) {
      switchScene(id, currentView.parameters().yaw, currentView.parameters().pitch);
      return;
    }
  }
}

window.moveForward = function() {
  var yaw = normalizeAngle(currentView.parameters().yaw);
  var isLookingFront = Math.abs(radToDeg(yaw)) <= 90;
  var delta = (currentSceneObj.data.direction === 'iki') ? (isLookingFront ? 1 : -1) : (isLookingFront ? -1 : 1);
  executeMoveByDelta(delta);
};

window.moveBackward = function() {
  var yaw = normalizeAngle(currentView.parameters().yaw);
  var isLookingFront = Math.abs(radToDeg(yaw)) <= 90;
  var delta = (currentSceneObj.data.direction === 'iki') ? (isLookingFront ? -1 : 1) : (isLookingFront ? 1 : -1);
  executeMoveByDelta(delta);
};

window.moveLeft = function() {
  var yaw = normalizeAngle(currentView.parameters().yaw);
  executeMoveByDelta(yaw < 0 ? -1 : 1);
};

window.moveRight = function() {
  var yaw = normalizeAngle(currentView.parameters().yaw);
  executeMoveByDelta(yaw > 0 ? -1 : 1);
};

// --- ジャイロ機能（修正済み：5秒で消滅、即時反応） ---
var permissionButton = document.getElementById('gyroPermissionButton');

function showPermissionButton() {
  // iOS 13+ の場合のみボタンを表示
  if (typeof DeviceOrientationEvent !== 'undefined' && 
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    
    permissionButton.style.display = 'block';
    
    // 5秒後に消す
    setTimeout(function() {
      permissionButton.style.opacity = '0';
      setTimeout(function() {
        permissionButton.style.display = 'none';
      }, 1000);
    }, 5000); 
  } else {
    // Androidなどは即時開始
    initGyro();
  }
}

if (permissionButton) {
  permissionButton.addEventListener('click', function() {
    DeviceOrientationEvent.requestPermission()
      .then(function(response) {
        if (response === 'granted') {
          permissionButton.style.display = 'none';
          initGyro();
        } else {
          alert('ジャイロの許可が必要です');
        }
      })
      .catch(function(error) {
        alert('エラー: ' + error);
      });
  });
}

function handleDeviceOrientation(event) {
  if (!gyroActive || !currentView) return;
  
  var alpha = event.alpha;
  var beta = event.beta;
  var gamma = event.gamma;
  
  if (alpha === null || beta === null || gamma === null) return;
  
  if (lastOrientation.alpha === null) {
    lastOrientation = { alpha: alpha, beta: beta, gamma: gamma };
    return;
  }
  
  var deltaBeta = beta - lastOrientation.beta;
  var deltaGamma = gamma - lastOrientation.gamma;
  
  var params = currentView.parameters();
  var sensitivity = 1.5; // 感度
  var orientation = window.orientation || 0;
  
  var newYaw = params.yaw, newPitch = params.pitch;
  
  // 画面の向きに応じて軸を入れ替える
  if (Math.abs(orientation) < 45 || Math.abs(orientation - 180) < 45) {
    // 縦持ち
    newYaw -= (deltaGamma * Math.PI / 180 * sensitivity);
    newPitch += (deltaBeta * Math.PI / 180 * sensitivity);
  } else if (Math.abs(orientation - 90) < 45) {
    // 横持ち（左）
    newYaw += (deltaBeta * Math.PI / 180 * sensitivity);
    newPitch += (deltaGamma * Math.PI / 180 * sensitivity);
  } else {
    // 横持ち（右）
    newYaw -= (deltaBeta * Math.PI / 180 * sensitivity);
    newPitch -= (deltaGamma * Math.PI / 180 * sensitivity);
  }
  
  var maxPitch = 75 * Math.PI / 180;
  newPitch = Math.max(-maxPitch, Math.min(maxPitch, newPitch));
  
  currentView.setParameters({ yaw: newYaw, pitch: newPitch });
  lastOrientation = { alpha: alpha, beta: beta, gamma: gamma };
}

function startIdleTimer() {
  // アイドルタイマー撤廃：即座にジャイロ有効化
  gyroActive = true;
  lastOrientation = { alpha: null, beta: null, gamma: null };
}

function initGyro() {
  if (gyroInitialized) return;
  gyroInitialized = true;
  window.addEventListener('deviceorientation', handleDeviceOrientation, true);
  startIdleTimer();
}

panoElement.addEventListener('touchstart', function() {
  // タッチ中はジャイロ一時停止したい場合はここを有効化
  // gyroActive = false; 
});
panoElement.addEventListener('touchend', function() {
  // タッチ終了後即復帰
  lastOrientation = { alpha: null, beta: null, gamma: null };
  gyroActive = true; 
});


// --- UI 自動フェード ---
var uiElements = [
  document.getElementById('mapButton'),
  document.getElementById('counter'),
  document.getElementById('volumeContainer'),
  document.getElementById('arrowUp'),
  document.getElementById('arrowDown'),
  document.getElementById('arrowLeft'),
  document.getElementById('arrowRight')
];

var hideTimer = null;
function showUI() {
  uiElements.forEach(function(el) { if (el) el.classList.add('visible'); });
  if (hideTimer) clearTimeout(hideTimer);
  hideTimer = setTimeout(function() {
    uiElements.forEach(function(el) { if (el) el.classList.remove('visible'); });
  }, 2000);
}
document.addEventListener('mousemove', showUI);
document.addEventListener('touchstart', showUI);


// --- 長押し移動 ---
var autoMoveInterval = null;
function startAutoMove(moveFunction) {
  if (autoMoveInterval) return;
  moveFunction();
  autoMoveInterval = setInterval(moveFunction, 800);
}
function stopAutoMove() {
  if (autoMoveInterval) { clearInterval(autoMoveInterval); autoMoveInterval = null; }
}

[arrowUp, arrowDown, arrowLeft, arrowRight].forEach(function(arrow) {
  if (!arrow) return;
  var moveFunc;
  if (arrow === arrowUp) moveFunc = window.moveForward;
  if (arrow === arrowDown) moveFunc = window.moveBackward;
  if (arrow === arrowLeft) moveFunc = window.moveLeft;
  if (arrow === arrowRight) moveFunc = window.moveRight;

  arrow.addEventListener('mousedown', function() { startAutoMove(moveFunc); });
  arrow.addEventListener('mouseup', stopAutoMove);
  arrow.addEventListener('mouseleave', stopAutoMove);
  arrow.addEventListener('touchstart', function(e) { e.preventDefault(); startAutoMove(moveFunc); });
  arrow.addEventListener('touchend', function(e) { e.preventDefault(); stopAutoMove(); });
});

// --- 初期ロード実行 ---
// 修正：data.jsの最初のシーンを強制的に読み込む
if (scenes && scenes.length > 0) {
  // URLパラメータがあればそれを優先、なければリストの先頭
  var targetSceneId = null;
  
  // パラメータチェック (scene=1 等)
  if (startSceneNum) {
     for(var id in scenesData) {
       if (scenesData[id].data.position === startSceneNum && scenesData[id].data.direction === 'iki') {
         targetSceneId = id;
         break;
       }
     }
  }

  // 見つからなければ強制的にリストの0番目（最初のシーン）を使う
  if (!targetSceneId) {
    targetSceneId = scenes[0].id;
  }

  switchScene(targetSceneId);
} else {
  alert("シーンデータが見つかりません。data.jsを確認してください。");
}

showUI();
showPermissionButton();

})();
</script>

</body>
</html>